<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.tailwindcss.com https://apis.openapi.sk.com https://*.tmap.co.kr;
    connect-src 'self' https://script.google.com https://script.googleusercontent.com;
    style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
    font-src https://fonts.gstatic.com;
    img-src 'self' data: https://*.daumcdn.net https://*.tmap.sk.com https://*.tmap.co.kr;
    frame-src 'self' blob:; 
  ">
  
  <style>
    /* 2. 맵이 뜰 공간을 100%로 채움 */
    html, body { height: 100%; margin: 0; padding: 0; }
    #map-container { width: 100%; height: 100%; }
    iframe { width: 100%; height: 100%; border: none; }
  </style>
</head>
<body>

  <h1>T맵 로딩 실험실 (이 글자가 보이면 메인 페이지는 성공)</h1>

  <div id="map-container">
    <iframe id="map-iframe" sandbox="allow-scripts allow-same-origin"></iframe>
  </div>

  <script>
    // 4. API 키 (실험용으로 하드코딩)
    // (주의: 이 파일은 테스트 후 삭제해야 함)
    const TMAP_API_KEY = "QePeg5ee414bGfjbIx13L55PmUEim1vl9tvBSyp0";

    // 5. 페이지가 로드되면 <iframe>에 지도 주입
    document.addEventListener('DOMContentLoaded', () => {
      console.log("페이지 로드 완료. <iframe>에 지도 주입 시작...");
      
      const iframe = document.getElementById('map-iframe');
      const doc = iframe.contentWindow.document;

      doc.open();
      // 6. 'doc.write'로 격리실 내부에 HTML을 씁니다.
      doc.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <style>body, html, #map_div { margin: 0; padding: 0; width: 100%; height: 100%; }<\/style>
          
          <script>
            function initMapInFrame() {
              console.log("IFRAME: initMapInFrame() 호출됨. 지도 생성 시도...");
              try {
                new Tmapv2.Map("map_div", {
                  center: new Tmapv2.LatLng(35.2128, 128.9806),
                  width: "100%",
                  height: "100%",
                  zoom: 12
                });
                console.log("IFRAME: 지도 생성 성공!");
              } catch (e) {
                console.error("IFRAME: 지도 생성 실패!", e);
                document.getElementById('map_div').textContent = "지도 로딩 실패: " + e.message;
              }
            }
          <\/script>
        </head>
        <body>
          <div id="map_div"></div>
          
          <script src="https://apis.openapi.sk.com/tmap/jsv2?version=1&appKey=${TMAP_API_KEY}&callback=initMapInFrame"><\/script>
        <\/body>
        <\/html>
      `);
      doc.close();
      
      console.log("<iframe> 주입 완료. Tmap 응답 대기 중...");
    });
  </script>
</body>
</html>
